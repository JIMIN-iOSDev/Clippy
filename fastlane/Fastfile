# Fastfile - Clippy ë¹Œë“œ ë° ë°°í¬ ìë™í™”

default_platform(:ios)

platform :ios do

  # MARK: - í…ŒìŠ¤íŠ¸ Lane

  desc "Run unit tests"
  lane :test do
    run_tests(
      project: "Clippy.xcodeproj",
      scheme: "Clippy",
      device: "iPhone 15 Pro",
      code_coverage: true
    )
  end

  # MARK: - ë² íƒ€ ë°°í¬ Lane (TestFlight)

  desc "Build and upload to TestFlight"
  lane :beta do
    # 1. ë¹Œë“œ ë²ˆí˜¸ ìë™ ì¦ê°€
    increment_build_number(
      xcodeproj: "Clippy.xcodeproj"
    )

    # 2. ì•± ë¹Œë“œ
    build_app(
      project: "Clippy.xcodeproj",
      scheme: "Clippy",
      export_method: "app-store",
      output_directory: "./build",
      output_name: "Clippy.ipa"
    )

    # 3. TestFlightì— ì—…ë¡œë“œ
    upload_to_testflight(
      skip_waiting_for_build_processing: true,
      apple_id: "6739104732"  # App Store Connectì˜ Apple ID
    )

    # 4. ì„±ê³µ ì•Œë¦¼ (ì„ íƒì‚¬í•­)
    # slack(
    #   message: "âœ… Clippy ë² íƒ€ ë²„ì „ì´ TestFlightì— ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!",
    #   success: true
    # )
  end

  # MARK: - í”„ë¡œë•ì…˜ ë°°í¬ Lane (App Store)

  desc "Deploy to App Store"
  lane :release do
    # 1. ë²„ì „ ë²ˆí˜¸ ì¦ê°€ (ë©”ì´ì €/ë§ˆì´ë„ˆ ë²„ì „)
    increment_version_number(
      bump_type: "patch"  # "major", "minor", "patch" ì¤‘ ì„ íƒ
    )

    # 2. ë¹Œë“œ ë²ˆí˜¸ ìë™ ì¦ê°€
    increment_build_number(
      xcodeproj: "Clippy.xcodeproj"
    )

    # 3. ì•± ë¹Œë“œ
    build_app(
      project: "Clippy.xcodeproj",
      scheme: "Clippy",
      export_method: "app-store"
    )

    # 4. App Storeì— ì—…ë¡œë“œ ë° ì‹¬ì‚¬ ì œì¶œ
    upload_to_app_store(
      submit_for_review: true,      # ìë™ ì‹¬ì‚¬ ì œì¶œ
      automatic_release: false,      # ìŠ¹ì¸ í›„ ìˆ˜ë™ ì¶œì‹œ (trueë¡œ í•˜ë©´ ìŠ¹ì¸ ì¦‰ì‹œ ì¶œì‹œ)
      force: true,                   # ë©”íƒ€ë°ì´í„° ì—…ë°ì´íŠ¸ ì—†ì´ ë°”ì´ë„ˆë¦¬ë§Œ ì—…ë¡œë“œ
      skip_metadata: true,
      skip_screenshots: true,
      precheck_include_in_app_purchases: false
    )

    # 5. ì„±ê³µ ì•Œë¦¼
    # slack(
    #   message: "ğŸ‰ Clippyê°€ App Store ì‹¬ì‚¬ì— ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤!",
    #   success: true
    # )
  end

  # MARK: - ìŠ¤í¬ë¦°ìƒ· ìƒì„± Lane (ì„ íƒì‚¬í•­)

  desc "Generate screenshots for App Store"
  lane :screenshots do
    snapshot(
      scheme: "ClippyUITests",
      devices: [
        "iPhone 15 Pro Max",
        "iPhone 15 Pro",
        "iPhone SE (3rd generation)",
        "iPad Pro (12.9-inch) (6th generation)"
      ]
    )
  end

  # MARK: - ë¹Œë“œë§Œ ìˆ˜í–‰ (ì—…ë¡œë“œ ì—†ì´)

  desc "Build app only (no upload)"
  lane :build do
    build_app(
      project: "Clippy.xcodeproj",
      scheme: "Clippy",
      export_method: "development",
      output_directory: "./build"
    )
  end

  # MARK: - ì—ëŸ¬ ì²˜ë¦¬

  error do |lane, exception|
    # ì—ëŸ¬ ë°œìƒ ì‹œ Slack ì•Œë¦¼ (ì„ íƒì‚¬í•­)
    # slack(
    #   message: "âŒ #{lane} ì‹¤íŒ¨: #{exception.message}",
    #   success: false
    # )
  end

end
